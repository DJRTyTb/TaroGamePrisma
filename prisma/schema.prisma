generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model Player {
  id                 String        @id @default(cuid())
  telegramId         String        @unique
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  lastDailyLevelDate DateTime?
  streak             Int           @default(0)

  inventoryItems     InventoryItem[]
  levelProgress      LevelProgress[]
  questProgress      PlayerQuestProgress[]
  // Убрал: transactions
  
  @@map("players")
}

// ========== GAME ENTITIES ==========
model TarotCard {
  id                  String       @id @default(cuid())
  name                String
  rarity              Int          // 1, 2, 3, 4 (special)
  descriptionTemplate String?
  imageBaseUrl        String
  isSpecial           Boolean      @default(false)
  
  item Item? // Обратная связь с Item
  
  @@map("tarot_cards")
}

model Shape {
  id              String        @id @default(cuid())
  name            String
  complexityLevel Int
  spriteUrl       String?
  unlockCondition Json?
  
  item Item? // Обратная связь с Item
  
  @@map("shapes")
}

// ========== ITEM SYSTEM ==========
model Item {
  id          String   @id @default(cuid())
  
  // УНИКАЛЬНЫЕ ПОЛЯ для one-to-one связи
  tarotCardId String?  @unique
  shapeId     String?  @unique
  // Убрал: currencyId
  
  name        String
  description String?
  rarity      Int      @default(1)
  iconUrl     String?
  // Убрал: isTradeable (пока не нужно)
  maxStack    Int      @default(1)
  createdAt   DateTime @default(now())
  
  // Связи
  tarotCard  TarotCard? @relation(fields: [tarotCardId], references: [id])
  shape      Shape?     @relation(fields: [shapeId], references: [id])
  // Убрал: currency
  
  inventoryItems InventoryItem[]
  // Убрал: shopItems, transactions
  questRewards   QuestReward[]
  
  @@map("items")
}

model InventoryItem {
  id         String   @id @default(cuid())
  playerId   String
  itemId     String
  quantity   Int      @default(1)
  obtainedAt DateTime @default(now())
  metadata   Json?    @default("{}")
  
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  @@unique([playerId, itemId])
  @@map("inventory_items")
}

// ========== PROGRESSION ==========
model Level {
  id                String          @id @default(cuid())
  date              DateTime?
  data              Json            // созвездие, расположение звезд
  patternsAvailable Json?
  levelProgress     LevelProgress[]
  
  @@map("levels")
}

model LevelProgress {
  id          String   @id @default(cuid())
  playerId    String
  levelId     String
  starsEarned Int
  completedAt DateTime @default(now())

  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  level  Level  @relation(fields: [levelId], references: [id], onDelete: Cascade)
  
  @@unique([playerId, levelId])
  @@map("level_progress")
}

// ========== QUESTS ==========
model Quest {
  id            String                @id @default(cuid())
  type          String                // SOCIAL, PROGRESSION, etc.
  title         String
  description   String
  conditionJson Json
  isActive      Boolean               @default(true)
  repeatsDaily  Boolean               @default(false)
  maxCompletions Int?                 // null = бесконечно
  
  progresses    PlayerQuestProgress[]
  rewards       QuestReward[]
  
  @@map("quests")
}

model PlayerQuestProgress {
  id             String   @id @default(cuid())
  playerId       String
  questId        String
  completions    Int      @default(0)
  lastCompletedAt DateTime?
  progressData   Json?    @default("{}")
  
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  quest  Quest  @relation(fields: [questId], references: [id], onDelete: Cascade)
  
  @@unique([playerId, questId])
  @@map("player_quest_progress")
}

model QuestReward {
  id          String   @id @default(cuid())
  questId     String
  itemId      String
  quantity    Int      @default(1)
  probability Int      @default(100)
  isGuaranteed Boolean @default(true)
  
  quest Quest @relation(fields: [questId], references: [id], onDelete: Cascade)
  item  Item  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  @@unique([questId, itemId])
  @@map("quest_rewards")
}